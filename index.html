<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Arch Guide â€“ All Buildings Map</title>

  <!-- MapKit JS -->
  <script
    src="https://cdn.apple-mapkitjs.com/mk/5.x.x/mapkit.js"
    crossorigin
  ></script>

  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
    }
    #map { width: 100%; height: 100%; }
    
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      color: #666;
      z-index: 10000;
    }
    
    /* Rounded image popup */
    .building-callout {
      width: 200px;
      height: 200px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      cursor: pointer;
      background: white;
    }
    
    .building-callout img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  </style>
</head>
<body>
  <div id="loading">Loading map...</div>
  <div id="map"></div>

  <script>
    // --- Configuration ---
    const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zdXptcmZ6emtxZmZocGlsaXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjY5NDAsImV4cCI6MjA4MjM0Mjk0MH0.kGHLaDT2FR9AAnZjP96FgAcSPjCQm6w9ifAqd6cEOoQ';
    
    // State
    let allBuildings = [];
    let buildingAnnotations = [];
    let currentFilter = 'all';
    let showUserLocation = false;
    let userLocationAnnotation = null;
    let userUnlockedIds = []; // TODO: Get from Draftbit or Supabase
    
    // Neighborhood colors for pins
    const NEIGHBORHOOD_COLORS = {
      'DTL': '#1150AB',
      'SLV': '#2E7D6F',
      'PAS': '#C56B3C',
      'LFZ': '#E85D75',
      'WHO': '#F4A261'
    };

    // --- MapKit Init ---
    mapkit.init({
      authorizationCallback: function(done) {
        done('eyJraWQiOiJSN05HVzZZNko3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiI4N05MV1VQUVFBIiwiaWF0IjoxNzY3NjcxMDk2LCJvcmlnaW4iOiJhcmNoZ3VpZGUuZ2l0aHViLmlvIn0.aGopUszusE4HfaiqItorz1NoVxzy5z46YItwrq43WVgyERsMm8kkmLZMJNUHd83c-icIhRra2mBFwgpdvYk-SA');
        // Hide loading
        setTimeout(() => {
          const loading = document.getElementById('loading');
          if (loading) loading.style.display = 'none';
        }, 500);
      }
    });

    // --- Create Map ---
    const map = new mapkit.Map("map", {
      center: new mapkit.Coordinate(34.0522, -118.2437),
      region: new mapkit.CoordinateRegion(
        new mapkit.Coordinate(34.0522, -118.2437),
        new mapkit.CoordinateSpan(0.25, 0.35)
      ),
      showsCompass: mapkit.FeatureVisibility.Hidden,
      showsScale: false,
      showsMapTypeControl: false,
      isZoomEnabled: true,
      isScrollEnabled: true
    });

    // --- Load All Buildings ---
    async function loadAllBuildings() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/buildings?select=id,title,latitude,longitude,image,neighborhood_id,is_free`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        
        allBuildings = await response.json();
        console.log(`Loaded ${allBuildings.length} total buildings`);
        
        // Show all buildings initially
        updateMarkers();
        
      } catch (error) {
        console.error('Error loading buildings:', error);
        document.getElementById('building-count').textContent = 'Error loading buildings';
      }
    }

    // --- Filter Toggle ---
    function toggleFilter(filterType) {
      // Update active states
      document.querySelectorAll('.filter-chip:not(.location)').forEach(chip => {
        chip.classList.remove('active');
      });
      document.getElementById(`filter-${filterType}`).classList.add('active');
      
      currentFilter = filterType;
      updateMarkers();
    }

    // --- Location Toggle ---
    function toggleLocation() {
      showUserLocation = !showUserLocation;
      const chip = document.getElementById('filter-location');
      
      if (showUserLocation) {
        chip.classList.add('active');
        enableUserLocation();
      } else {
        chip.classList.remove('active');
        disableUserLocation();
      }
    }

    // --- Enable User Location ---
    function enableUserLocation() {
      if (!navigator.geolocation) {
        alert('Geolocation not supported');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userCoord = new mapkit.Coordinate(
            position.coords.latitude,
            position.coords.longitude
          );
          
          // Remove old user location marker
          if (userLocationAnnotation) {
            map.removeAnnotation(userLocationAnnotation);
          }
          
          // Add blue dot for user location
          userLocationAnnotation = new mapkit.MarkerAnnotation(userCoord, {
            color: '#007AFF',
            glyphText: 'ðŸ“',
            title: 'Your Location'
          });
          
          map.addAnnotation(userLocationAnnotation);
          
          // Center map on user location
          map.setCenterAnimated(userCoord, true);
          
        },
        (error) => {
          console.error('Location error:', error);
          alert('Could not get your location');
          showUserLocation = false;
          document.getElementById('filter-location').classList.remove('active');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // --- Disable User Location ---
    function disableUserLocation() {
      if (userLocationAnnotation) {
        map.removeAnnotation(userLocationAnnotation);
        userLocationAnnotation = null;
      }
    }

    // --- Update Markers Based on Filter ---
    function updateMarkers() {
      // Clear existing markers
      buildingAnnotations.forEach(annotation => map.removeAnnotation(annotation));
      buildingAnnotations = [];
      
      // Filter buildings
      let filteredBuildings = allBuildings;
      
      if (currentFilter === 'free') {
        filteredBuildings = allBuildings.filter(b => b.is_free === true);
      } else if (currentFilter === 'unlocked') {
        filteredBuildings = allBuildings.filter(b => userUnlockedIds.includes(b.id));
      }
      
      // Add markers
      filteredBuildings.forEach(building => {
        if (!building.latitude || !building.longitude) return;
        
        const pinColor = NEIGHBORHOOD_COLORS[building.neighborhood_id] || '#666666';
        
        const annotation = new mapkit.MarkerAnnotation(
          new mapkit.Coordinate(building.latitude, building.longitude),
          {
            color: pinColor,
            glyphText: '',
            title: building.title,
            data: building
          }
        );
        
        // Custom callout - just rounded image
        annotation.callout = {
          calloutElementForAnnotation: function(annotation) {
            const building = annotation.data;
            const callout = document.createElement('div');
            callout.className = 'building-callout';
            
            if (building.image) {
              callout.innerHTML = `<img src="${building.image}" alt="${building.title}" />`;
            } else {
              callout.innerHTML = `<div style="width:100%; height:100%; background:#ddd; display:flex; align-items:center; justify-content:center; font-size:14px; color:#666;">No Image</div>`;
            }
            
            // Click handler
            callout.addEventListener('click', () => {
              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                  action: 'navigateToBuilding',
                  buildingId: building.id,
                  buildingTitle: building.title
                }));
              } else {
                console.log('Navigate to building:', building.id);
              }
            });
            
            return callout;
          }
        };
        
        map.addAnnotation(annotation);
        buildingAnnotations.push(annotation);
      });
      
      console.log(`Showing ${filteredBuildings.length} buildings (filter: ${currentFilter})`);
    }

    // --- Initialize ---
    // Load buildings
    loadAllBuildings();
    
    // Listen for unlocked building IDs from Draftbit
    window.addEventListener('message', (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.action === 'setUnlockedBuildings' && Array.isArray(data.buildingIds)) {
          userUnlockedIds = data.buildingIds;
          console.log('Received unlocked building IDs:', userUnlockedIds);
          // Refresh if currently showing unlocked filter
          if (currentFilter === 'unlocked') {
            updateMarkers();
          }
        }
      } catch (e) {
        // Ignore non-JSON messages
      }
    });
  </script>
</body>
</html>
