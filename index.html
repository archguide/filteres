// ✅ ADD FILTERS (drop this into the ALL BUILDINGS MAP script)
// 1) Replace your loadAllBuildings() with this version
// 2) Add updateMarkers() + message listener below
// Filter values supported: "all" | "free" | "unlocked" | "neighborhood:DTL" (or SLV/PAS/etc)

let allBuildings = [];
let currentFilter = "all";
let userUnlockedIds = [];
let buildingAnnotations = [];

async function loadAllBuildings() {
  try {
    const response = await fetch(
      `${SUPABASE_URL}/rest/v1/buildings?select=id,title,latitude,longitude,image,neighborhood_id,is_free`,
      {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`
        }
      }
    );

    allBuildings = await response.json();
    updateMarkers();
  } catch (e) {
    console.error("loadAllBuildings error:", e);
  }
}

function updateMarkers() {
  // clear existing
  buildingAnnotations.forEach(a => map.removeAnnotation(a));
  buildingAnnotations = [];

  let filtered = allBuildings;

  if (currentFilter === "free") {
    filtered = allBuildings.filter(b => b.is_free === true);
  } else if (currentFilter === "unlocked") {
    filtered = allBuildings.filter(b => userUnlockedIds.includes(b.id));
  } else if (currentFilter.startsWith("neighborhood:")) {
    const nid = currentFilter.split(":")[1];
    filtered = allBuildings.filter(b => b.neighborhood_id === nid);
  }

  filtered.forEach(b => {
    if (!b.latitude || !b.longitude) return;

    const ann = new mapkit.MarkerAnnotation(
      new mapkit.Coordinate(Number(b.latitude), Number(b.longitude)),
      {
        color: NEIGHBORHOOD_COLORS[b.neighborhood_id] || "#666666",
        glyphText: "",
        title: b.title,
        data: b
      }
    );

    ann.callout = {
      calloutElementForAnnotation: function(annotation) {
        const building = annotation.data;
        const callout = document.createElement("div");
        callout.className = "building-callout";

        callout.innerHTML = building.image
          ? `<img src="${building.image}" alt="${building.title}" />`
          : `<div style="width:100%; height:100%; background:#ddd; display:flex; align-items:center; justify-content:center; font-size:14px; color:#666;">No Image</div>`;

        callout.addEventListener("click", () => {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              action: "navigateToBuilding",
              buildingId: building.id,
              buildingTitle: building.title
            }));
          }
        });

        return callout;
      }
    };

    map.addAnnotation(ann);
    buildingAnnotations.push(ann);
  });

  if (buildingAnnotations.length) map.showItems(buildingAnnotations);
}

// ✅ DRAFTBIT / APP -> WEBVIEW FILTER CONTROL
// Send messages like:
// { "action":"setFilter", "filter":"free" }
// { "action":"setFilter", "filter":"unlocked" }
// { "action":"setFilter", "filter":"neighborhood:DTL" }
// { "action":"setUnlockedBuildings", "buildingIds":["uuid1","uuid2"] }
window.addEventListener("message", (event) => {
  try {
    const data = JSON.parse(event.data);

    if (data.action === "setFilter") {
      currentFilter = data.filter || "all";
      updateMarkers();
    }

    if (data.action === "setUnlockedBuildings" && Array.isArray(data.buildingIds)) {
      userUnlockedIds = data.buildingIds;
      if (currentFilter === "unlocked") updateMarkers();
    }
  } catch (e) {}
});
