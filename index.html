<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Arch Guide â€“ Buildings Map</title>

  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" crossorigin></script>

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zdXptcmZ6emtxZmZocGlsaXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjY5NDAsImV4cCI6MjA4MjM0Mjk0MH0.kGHLaDT2FR9AAnZjP96FgAcSPjCQm6w9ifAqd6cEOoQ';
    
    const MAPKIT_TOKEN = 'eyJraWQiOiJSN05HVzZZNko3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiI4N05MV1VQUVFBIiwiaWF0IjoxNzY3NjcxMDk2LCJvcmlnaW4iOiJhcmNoZ3VpZGUuZ2l0aHViLmlvIn0.aGopUszusE4HfaiqItorz1NoVxzy5z46YItwrq43WVgyERsMm8kkmLZMJNUHd83c-icIhRra2mBFwgpdvYk-SA';

    const NEIGHBORHOOD_COLORS = {
      'DTL': '#1150AB',
      'SLV': '#2E7D6F', 
      'PAS': '#C56B3C',
      'LFZ': '#E85D75',
      'WHO': '#F4A261'
    };

    // --- Get parameters from URL ---
    const params = new URLSearchParams(window.location.search);
    const USER_ID = params.get('user_id');
    
    if (!USER_ID) {
      document.body.innerHTML = '<div style="padding:20px;color:red;">Error: user_id required</div>';
      throw new Error('USER_ID missing from URL');
    }

    // --- MapKit Init ---
    mapkit.init({
      authorizationCallback: function(done) {
        done(MAPKIT_TOKEN);
      }
    });

    const map = new mapkit.Map("map", {
      center: new mapkit.Coordinate(34.0522, -118.2437),
      region: new mapkit.CoordinateRegion(
        new mapkit.Coordinate(34.0522, -118.2437),
        new mapkit.CoordinateSpan(0.4, 0.5)
      ),
      showsCompass: mapkit.FeatureVisibility.Hidden,
      showsScale: false,
      showsMapTypeControl: false,
      isZoomEnabled: true,
      isScrollEnabled: true
    });

    // --- State ---
    let allBuildings = [];
    let unlockedSet = new Set();
    let tourStops = [];
    let tourRoute = [];
    let buildingAnnotations = [];
    let routePolylines = [];

    // --- Helper functions ---
    async function supaJson(path) {
      const res = await fetch(`${SUPABASE_URL}${path}`, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Accept': 'application/json'
        }
      });
      if (!res.ok) {
        const error = await res.text();
        console.error('Supabase error:', error);
        throw new Error(`Supabase: ${res.status} ${error}`);
      }
      return res.json();
    }

    // --- Data loading ---
    async function loadBuildingsOnce() {
      try {
        allBuildings = await supaJson(
          `/rest/v1/buildings?select=id,title,latitude,longitude,image,neighborhood_id,is_free`
        );
        console.log(`Loaded ${allBuildings.length} buildings`);
      } catch (err) {
        console.error('Failed to load buildings:', err);
        allBuildings = [];
      }
    }

    async function loadUnlockedOnce() {
      try {
        const rows = await supaJson(
          `/rest/v1/user_building_unlocks?user_id=eq.${encodeURIComponent(USER_ID)}&select=building_id`
        );
        unlockedSet = new Set(rows.map(r => r.building_id));
        console.log(`User has ${unlockedSet.size} unlocked buildings`);
      } catch (err) {
        console.log('No unlocked buildings data');
        unlockedSet = new Set();
      }
    }

    async function loadTourData(tourId) {
      if (!tourId) return;
      
      try {
        const stops = await supaJson(
          `/rest/v1/tour_stops?tour_id=eq.${encodeURIComponent(tourId)}&select=building_id,stop_order&order=stop_order`
        );
        tourStops = stops;
        console.log(`Tour has ${tourStops.length} stops`);

        try {
          const route = await supaJson(
            `/rest/v1/tour_routes?tour_id=eq.${encodeURIComponent(tourId)}&select=route_points,route_order&order=route_order`
          );
          tourRoute = route;
          console.log(`Tour has ${tourRoute.length} route segments`);
        } catch (err) {
          console.log('No tour route data');
          tourRoute = [];
        }
      } catch (err) {
        console.error('Failed to load tour data:', err);
        tourStops = [];
        tourRoute = [];
      }
    }

    // --- Map management ---
    function clearPins() {
      buildingAnnotations.forEach(a => map.removeAnnotation(a));
      buildingAnnotations = [];
    }

    function clearRoutes() {
      routePolylines.forEach(p => map.removeOverlay(p));
      routePolylines = [];
    }

    function addPins(buildings) {
      clearPins();
      
      buildings.forEach(b => {
        if (!b.latitude || !b.longitude) return;

        const ann = new mapkit.MarkerAnnotation(
          new mapkit.Coordinate(Number(b.latitude), Number(b.longitude)),
          {
            color: NEIGHBORHOOD_COLORS[b.neighborhood_id] || '#666666',
            glyphText: '',
            title: b.title,
            data: b
          }
        );

        ann.callout = {
          calloutElementForAnnotation: function(annotation) {
            const building = annotation.data;
            const callout = document.createElement('div');
            callout.style.cssText = `
              width:155px;height:155px;border-radius:12px;overflow:hidden;
              box-shadow:0 8px 24px rgba(0,0,0,0.25);cursor:pointer;background:white;
            `;
            callout.innerHTML = building.image
              ? `<img src="${building.image}" alt="${building.title}" style="width:100%;height:100%;object-fit:cover;display:block;" />`
              : `<div style="width:100%;height:100%;background:#ddd;display:flex;align-items:center;justify-content:center;font-size:14px;color:#666;">No Image</div>`;

            callout.addEventListener('click', () => {
              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                  action: 'navigateToBuilding',
                  buildingId: building.id,
                  buildingTitle: building.title
                }));
              }
            });

            return callout;
          }
        };

        map.addAnnotation(ann);
        buildingAnnotations.push(ann);
      });

      console.log(`Added ${buildingAnnotations.length} pins to map`);
    }

    function focusMapOnPins() {
      if (buildingAnnotations.length === 0) return;
      
      // Get bounds of all pins
      let minLat = buildingAnnotations[0].coordinate.latitude;
      let maxLat = buildingAnnotations[0].coordinate.latitude;
      let minLng = buildingAnnotations[0].coordinate.longitude;
      let maxLng = buildingAnnotations[0].coordinate.longitude;

      buildingAnnotations.forEach(ann => {
        const lat = ann.coordinate.latitude;
        const lng = ann.coordinate.longitude;
        if (lat < minLat) minLat = lat;
        if (lat > maxLat) maxLat = lat;
        if (lng < minLng) minLng = lng;
        if (lng > maxLng) maxLng = lng;
      });

      // Add padding
      const latPadding = (maxLat - minLat) * 0.1;
      const lngPadding = (maxLng - minLng) * 0.1;

      const center = new mapkit.Coordinate(
        (minLat + maxLat) / 2,
        (minLng + maxLng) / 2
      );

      const span = new mapkit.CoordinateSpan(
        Math.max((maxLat - minLat) + latPadding, 0.01),
        Math.max((maxLng - minLng) + lngPadding, 0.01)
      );

      map.setRegion(new mapkit.CoordinateRegion(center, span), true);
    }

    function addRoutePolylines() {
      clearRoutes();
      
      if (!tourRoute || tourRoute.length === 0) return;

      tourRoute.forEach(segment => {
        if (!segment.route_points) return;

        try {
          const points = JSON.parse(segment.route_points);
          const coordinates = points.map(p => new mapkit.Coordinate(p.lat, p.lng));
          
          if (coordinates.length < 2) return;

          const polyline = new mapkit.PolylineOverlay(coordinates, {
            style: new mapkit.Style({
              strokeColor: '#1150AB',
              strokeWidth: 4,
              strokeOpacity: 0.8
            })
          });

          map.addOverlay(polyline);
          routePolylines.push(polyline);
        } catch (err) {
          console.error('Failed to parse route points:', err);
        }
      });

      console.log(`Added ${routePolylines.length} route segments`);
    }

    // --- Main filter logic ---
    function applyFilters() {
      // Check if this is tour mode
      const tourId = params.get('tour_id');
      
      if (tourId) {
        // TOUR MODE
        const tourStopIds = new Set(tourStops.map(s => s.building_id));
        const filteredBuildings = allBuildings.filter(b => tourStopIds.has(b.id));
        
        addPins(filteredBuildings);
        addRoutePolylines();
        focusMapOnPins();
        return;
      }

      // DISCOVERY MODE - Apply filters
      const showAvailable = params.get('show_available') !== 'false';
      const showLocked = params.get('show_locked') !== 'false';
      const filterNeighborhood = params.get('neighborhood');
      const userLocation = params.get('location');

      const filteredBuildings = allBuildings.filter(b => {
        // Availability filter
        const isFree = b.is_free === true;
        const isUnlocked = unlockedSet.has(b.id);
        const isAvailable = isFree || isUnlocked;
        
        if (isAvailable && !showAvailable) return false;
        if (!isAvailable && !showLocked) return false;

        // Neighborhood filter
        if (filterNeighborhood && filterNeighborhood !== 'ALL' && b.neighborhood_id !== filterNeighborhood) {
          return false;
        }

        return true;
      });

      addPins(filteredBuildings);

      // Handle user location for map centering
      if (userLocation) {
        const locationParts = userLocation.split(',');
        if (locationParts.length >= 2) {
          const userLat = Number(locationParts[0]);
          const userLng = Number(locationParts[1]);
          const radiusKm = locationParts[2] ? Number(locationParts[2]) : 5;
          
          if (!isNaN(userLat) && !isNaN(userLng)) {
            // Convert km to approximate degrees (rough conversion)
            const spanSize = (radiusKm / 111) * 2;
            
            map.setRegion(new mapkit.CoordinateRegion(
              new mapkit.Coordinate(userLat, userLng),
              new mapkit.CoordinateSpan(spanSize, spanSize)
            ), true);
            return;
          }
        }
      }

      // Default: focus on filtered pins
      focusMapOnPins();
    }

    // --- Initialize ---
    (async function init() {
      try {
        await loadBuildingsOnce();
        await loadUnlockedOnce();
        
        const tourId = params.get('tour_id');
        if (tourId) {
          await loadTourData(tourId);
        }

        applyFilters();
      } catch (err) {
        console.error('Initialization error:', err);
        document.body.innerHTML = `<div style="padding:20px;color:red;">Error: ${err.message}</div>`;
      }
    })();
  </script>
</body>
</html>
