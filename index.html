<!-- ✅ ALL BUILDINGS MAP (same table as neighborhood map, same pins/callouts, no circles) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Arch Guide – All Buildings Map</title>

  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" crossorigin></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    .building-callout {
      width: 155px;
      height: 155px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      cursor: pointer;
      background: white;
    }

    .building-callout img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zdXptcmZ6emtxZmZocGlsaXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjY5NDAsImV4cCI6MjA4MjM0Mjk0MH0.kGHLaDT2FR9AAnZjP96FgAcSPjCQm6w9ifAqd6cEOoQ';

    const NEIGHBORHOOD_COLORS = {
      'DTL': '#1150AB',
      'SLV': '#2E7D6F',
      'PAS': '#C56B3C',
      'LFZ': '#E85D75',
      'WHO': '#F4A261'
    };

    let buildingAnnotations = [];

    mapkit.init({
      authorizationCallback: function(done) {
        done('eyJraWQiOiJSN05HVzZZNko3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiI4N05MV1VQUVFBIiwiaWF0IjoxNzY3NjcxMDk2LCJvcmlnaW4iOiJhcmNoZ3VpZGUuZ2l0aHViLmlvIn0.aGopUszusE4HfaiqItorz1NoVxzy5z46YItwrq43WVgyERsMm8kkmLZMJNUHd83c-icIhRra2mBFwgpdvYk-SA');
        loadAllBuildings();
      }
    });

    const map = new mapkit.Map("map", {
      center: new mapkit.Coordinate(34.0522, -118.2437),
      region: new mapkit.CoordinateRegion(
        new mapkit.Coordinate(34.0522, -118.2437),
        new mapkit.CoordinateSpan(0.25, 0.35)
      ),
      showsCompass: mapkit.FeatureVisibility.Hidden,
      showsScale: false,
      showsMapTypeControl: false,
      isZoomEnabled: true,
      isScrollEnabled: true
    });

    async function loadAllBuildings() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/buildings?select=id,title,latitude,longitude,image,neighborhood_id`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );

        const buildings = await response.json();

        buildings.forEach(b => {
          if (!b.latitude || !b.longitude) return;

          const ann = new mapkit.MarkerAnnotation(
            new mapkit.Coordinate(Number(b.latitude), Number(b.longitude)),
            {
              color: NEIGHBORHOOD_COLORS[b.neighborhood_id] || '#666666',
              glyphText: '',
              title: b.title,
              data: b
            }
          );

          ann.callout = {
            calloutElementForAnnotation: function(annotation) {
              const building = annotation.data;
              const callout = document.createElement('div');
              callout.className = 'building-callout';

              if (building.image) {
                callout.innerHTML = `<img src="${building.image}" alt="${building.title}" />`;
              } else {
                callout.innerHTML = `<div style="width:100%; height:100%; background:#ddd; display:flex; align-items:center; justify-content:center; font-size:14px; color:#666;">No Image</div>`;
              }

              callout.addEventListener('click', () => {
                if (window.ReactNativeWebView) {
                  window.ReactNativeWebView.postMessage(JSON.stringify({
                    action: 'navigateToBuilding',
                    buildingId: building.id,
                    buildingTitle: building.title
                  }));
                }
              });

              return callout;
            }
          };

          map.addAnnotation(ann);
          buildingAnnotations.push(ann);
        });

        if (buildingAnnotations.length) {
          map.showItems(buildingAnnotations);
        }
      } catch (e) {
        console.error('loadAllBuildings error:', e);
      }
    }
  </script>
</body>
</html>
