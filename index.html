<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" crossorigin></script>

  <style>
    html, body, #map { margin:0; padding:0; height:100%; width:100%; }
    .building-callout {
      width:155px;
      height:155px;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }
    .building-callout img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_KEY';

const COLORS = {
  DTL:'#1150AB', SLV:'#2E7D6F', PAS:'#C56B3C', LFZ:'#E85D75', WHO:'#F4A261'
};

mapkit.init({
  authorizationCallback: done => done('YOUR_MAPKIT_TOKEN')
});

const map = new mapkit.Map("map", {
  center: new mapkit.Coordinate(34.0522,-118.2437),
  region: new mapkit.CoordinateRegion(
    new mapkit.Coordinate(34.0522,-118.2437),
    new mapkit.CoordinateSpan(0.25,0.35)
  )
});

(async function(){
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/buildings?select=id,title,latitude,longitude,image,neighborhood_id`,
    { headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`} }
  );
  const buildings = await res.json();
  const anns=[];

  buildings.forEach(b=>{
    if(!b.latitude||!b.longitude) return;
    const ann = new mapkit.MarkerAnnotation(
      new mapkit.Coordinate(+b.latitude,+b.longitude),
      { color:COLORS[b.neighborhood_id]||'#666', data:b }
    );
    ann.callout = {
      calloutElementForAnnotation: a => {
        const el=document.createElement('div');
        el.className='building-callout';
        el.innerHTML=b.image?`<img src="${b.image}">`:`<div>No Image</div>`;
        el.onclick=()=>window.ReactNativeWebView?.postMessage(
          JSON.stringify({action:'navigateToBuilding',buildingId:b.id})
        );
        return el;
      }
    };
    map.addAnnotation(ann);
    anns.push(ann);
  });

  if(anns.length) map.showItems(anns);
})();
</script>
</body>
</html>
